name: CMake Multi-Platform Build

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Windows Latest MSVC"
            os: windows-latest
            artifact: "windows-msvc"
            build_type: "Release"
            cc: "cl"
            cxx: "cl"
            generators: "Visual Studio 17 2022"
            
          - name: "Ubuntu Latest GCC"
            os: ubuntu-latest
            artifact: "linux-gcc"
            build_type: "Release"
            cc: "gcc"
            cxx: "g++"
            generators: "Ninja"
            
          - name: "macOS Latest Clang"
            os: macos-latest
            artifact: "macos-clang"
            build_type: "Release"
            cc: "clang"
            cxx: "clang++"
            generators: "Ninja"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Ninja (Unix)
      if: runner.os != 'Windows'
      uses: seanmiddleditch/gha-setup-ninja@v4

    - name: Install Vulkan SDK (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $Version = "1.3.290.0"
        $Installer = "VulkanSDK-$Version-Installer.exe"
        $DownloadURL = "https://sdk.lunarg.com/sdk/download/$Version/windows/$Installer"
        
        Write-Host "Downloading Vulkan SDK..."
        Invoke-WebRequest -Uri $DownloadURL -OutFile $Installer
        
        Write-Host "Installing Vulkan SDK..."
        Start-Process -FilePath $Installer -ArgumentList "/S" -Wait
        
        Write-Host "Setting environment variables..."
        $env:VULKAN_SDK = "C:\VulkanSDK\$Version"
        echo "VULKAN_SDK=$env:VULKAN_SDK" >> $env:GITHUB_ENV
        echo "$env:VULKAN_SDK\Bin" >> $env:GITHUB_PATH

    - name: Install Vulkan SDK (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
        sudo apt-get update
        sudo apt-get install -y vulkan-sdk
        
        # Install additional dependencies
        sudo apt-get install -y \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libwayland-dev \
          libxkbcommon-dev

    - name: Install Vulkan SDK (macOS)
      if: runner.os == 'macOS'
      run: |
        wget https://sdk.lunarg.com/sdk/download/latest/mac/vulkan-sdk.dmg
        hdiutil attach vulkan-sdk.dmg
        VULKAN_SDK_PATH=$(find /Volumes -name "vulkansdk-macos-*" -type d 2>/dev/null | head -n 1)
        sudo "${VULKAN_SDK_PATH}/InstallVulkan.app/Contents/MacOS/InstallVulkan" \
          --root ~/VulkanSDK --accept-licenses --default-answer --confirm-command install
        cd ~/VulkanSDK
        VULKAN_VERSION=$(ls -1 | head -n 1)
        echo "VULKAN_SDK=$HOME/VulkanSDK/$VULKAN_VERSION/macOS" >> $GITHUB_ENV
        echo "$HOME/VulkanSDK/$VULKAN_VERSION/macOS/bin" >> $GITHUB_PATH

    - name: Verify Vulkan Installation
      run: |
        echo "VULKAN_SDK: ${{ env.VULKAN_SDK }}"
        
    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

    - name: Configure CMake
      run: >
        cmake -B ${{ steps.strings.outputs.build-output-dir }}
        -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }}
        -DCMAKE_C_COMPILER=${{ matrix.config.cc }}
        -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }}
        -G "${{ matrix.config.generators }}"
        -S ${{ github.workspace }}

    - name: Build
      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.config.build_type }}

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.config.artifact }}
        path: ${{ steps.strings.outputs.build-output-dir }}/bin/
        retention-days: 7
